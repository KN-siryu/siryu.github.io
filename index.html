<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pixel Platformer dengan Shooting, Ulti & Bos</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #87CEEB, #4682B4);
            font-family: 'Courier New', monospace;
        }
        canvas {
            border: 4px solid #8B4513;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #000;
            image-rendering: pixelated;
        }
        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px #000;
        }
        #level {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px #000;
        }
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FF4500;
            font-size: 36px;
            text-align: center;
            text-shadow: 2px 2px #000;
            display: none;
        }
        /* Energy bar container */
        #energyBarContainer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 20px;
            border: 2px solid #FFD700;
            background-color: #333;
        }
        #energyBarFill {
            width: 0%;
            height: 100%;
            background-color: #00CED1; /* warna energi */
            transition: width 0.1s;
        }
        #ultiPrompt {
            position: absolute;
            bottom: 50px;
            left: 20px;
            color: #00FF00;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px #000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="score">Skor: 0</div>
    <div id="level">Level: 1</div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div id="gameOver">Game Over!<br>Tekan tombol apa saja untuk restart.</div>
    <div id="energyBarContainer"><div id="energyBarFill"></div></div>
    <div id="ultiPrompt">ULTI READY! Tekan Shift!</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const gameOverElement = document.getElementById('gameOver');
        const energyBarFill = document.getElementById('energyBarFill');
        const ultiPrompt = document.getElementById('ultiPrompt');

        const gravity = 0.5;
        const jumpStrength = -12;
        const baseMoveSpeed = 5;
        const bulletSpeed = 10;
        const bulletWidth = 6;
        const bulletHeight = 3;
        const shootCooldownMax = 20;

        const maxEnergy = 100;
        let energy = 0;
        const energyGainRate = 0.3; // energi bertambah tiap frame saat pemain bergerak atau lompat
        const ultiEnergyCost = 100;
        let ultiReady = false;

        let level = 1;
        let player = { x: 50, y: 300, width: 20, height: 20, dx: 0, dy: 0, onGround: false, canJump: true, frame: 0, direction: 1 };
        let platforms = [
            { x: 0, y: 350, width: 800, height: 50 },
            { x: 200, y: 250, width: 100, height: 20 },
            { x: 400, y: 200, width: 100, height: 20 },
            { x: 600, y: 150, width: 100, height: 20 }
        ];
        let obstacles = [
            { x: 300, y: 330, width: 20, height: 20, dx: 2 },
            { x: 500, y: 180, width: 20, height: 20, dx: -2 }
        ];
        let coins = [
            { x: 250, y: 230, width: 10, height: 10 },
            { x: 450, y: 180, width: 10, height: 10 },
            { x: 650, y: 130, width: 10, height: 10 }
        ];
        let door = null;
        let particles = [];
        let bullets = [];
        let shootCooldown = 0;
        let score = 0;
        let gameRunning = true;
        let frameCount = 0;

        let boss = null;
        let bossBullets = [];
        const bossWidth = 40;
        const bossHeight = 40;
        const bossSpeed = 2;
        const bossBulletSpeed = 8;
        const bossShootIntervalMax = 90;
        let bossShootInterval = bossShootIntervalMax;

        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#4682B4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(100, 50, 60, 20);
            ctx.fillRect(120, 40, 20, 20);
            ctx.fillRect(500, 80, 80, 25);
            ctx.fillRect(520, 70, 25, 25);
        }

        function drawPixel(x, y, width, height, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, height);
        }

        function drawPlayer() {
            const baseColor = '#00FF00';
            const eyeColor = '#000000';

            drawPixel(player.x, player.y, player.width, player.height, baseColor);
            drawPixel(player.x + 5, player.y + 5, 2, 2, eyeColor);
            drawPixel(player.x + 13, player.y + 5, 2, 2, eyeColor);

            if (player.dx !== 0 && player.onGround) {
                player.frame = (player.frame + 1) % 10;
                if (player.frame < 5) {
                    drawPixel(player.x + 5, player.y + 18, 4, 2, baseColor);
                } else {
                    drawPixel(player.x + 11, player.y + 18, 4, 2, baseColor);
                }
            }
        }

        function updateGame() {
            if (!gameRunning) return;

            frameCount++;
            if (shootCooldown > 0) shootCooldown--;

            // energi bertambah jika bergerak atau lompat
            if ((player.dx !== 0 || !player.onGround)) {
                energy += energyGainRate;
                if (energy > maxEnergy) energy = maxEnergy;
            }

            // cek kesiapan ulti
            if (energy >= maxEnergy) {
                ultiReady = true;
                ultiPrompt.style.display = 'block';
            } else {
                ultiPrompt.style.display = 'none';
            }

            player.x += player.dx;
            player.y += player.dy;

            if (!player.onGround) {
                player.dy += gravity;
            }

            player.onGround = false;
            for (let plat of platforms) {
                if (player.x < plat.x + plat.width &&
                    player.x + player.width > plat.x &&
                    player.y < plat.y + plat.height &&
                    player.y + player.height > plat.y &&
                    player.dy >= 0) {
                    player.y = plat.y - player.height;
                    player.dy = 0;
                    player.onGround = true;
                    player.canJump = true;
                }
            }

            for (let obs of obstacles) {
                if (player.x < obs.x + obs.width &&
                    player.x + player.width > obs.x &&
                    player.y < obs.y + obs.height &&
                    player.y + player.height > obs.y) {
                    gameOver();
                    return;
                }
            }

            for (let i = coins.length - 1; i >= 0; i--) {
                let coin = coins[i];
                if (player.x < coin.x + coin.width &&
                    player.x + player.width > coin.x &&
                    player.y < coin.y + coin.height &&
                    player.y + player.height > coin.y) {
                    coins.splice(i, 1);
                    score += 10;
                    energy += 10; // memberi bonus energi ketika kumpul koin
                    if (energy > maxEnergy) energy = maxEnergy;
                    scoreElement.textContent = `Skor: ${score}`;
                    for (let j = 0; j < 5; j++) {
                        particles.push({ x: coin.x + 5, y: coin.y, dy: -1, life: 20 });
                    }
                }
            }

            if (coins.length === 0 && !door && !boss && level < 5) {
                spawnDoor();
            }

            if (door && player.x < door.x + door.width &&
                player.x + player.width > door.x &&
                player.y < door.y + door.height &&
                player.y + player.height > door.y) {
                nextLevel();
            }

            for (let obs of obstacles) {
                obs.x += obs.dx;
                if (obs.x <= 0 || obs.x + obs.width >= canvas.width) {
                    obs.dx *= -1;
                }
            }

            if (player.y > canvas.height) {
                gameOver();
            }

            updateBullets();
            if (level >=5) updateBoss();

            // update tampilan bar energi
            energyBarFill.style.width = (energy / maxEnergy * 100) + '%';
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.dx;
                if (b.x < 0 || b.x > canvas.width) {
                    bullets.splice(i, 1);
                    continue;
                }
                for (let j = obstacles.length - 1; j >= 0; j--) {
                    let obs = obstacles[j];
                    if (b.x < obs.x + obs.width &&
                        b.x + b.width > obs.x &&
                        b.y < obs.y + obs.height &&
                        b.y + b.height > obs.y) {
                        bullets.splice(i, 1);
                        obstacles.splice(j, 1);
                        score += 50;
                        energy += 20; // bonus energi jika menghancurkan rintangan
                        if (energy > maxEnergy) energy = maxEnergy;
                        scoreElement.textContent = `Skor: ${score}`;
                        break;
                    }
                }
                if (boss) {
                    if (b.x < boss.x + boss.width &&
                        b.x + b.width > boss.x &&
                        b.y < boss.y + boss.height &&
                        b.y + b.height > boss.y) {
                        bullets.splice(i, 1);
                        boss.health--;
                        if (boss.health <= 0) {
                            boss = null;
                            nextLevel();
                        }
                    }
                }
            }
        }

        function spawnDoor() {
            let plat = platforms[Math.floor(Math.random() * platforms.length)];
            door = { x: plat.x + Math.random()*(plat.width -30), y: plat.y-30, width: 20, height: 30 };
        }

        function spawnBoss() {
            boss = {
                x: canvas.width - 100,
                y: 50,
                width: bossWidth,
                height: bossHeight,
                dx: -bossSpeed,
                health: 10
            };
            bossBullets = [];
            bossShootInterval = bossShootIntervalMax;
        }

        function updateBoss() {
            if (!boss) return;
            boss.x += boss.dx;
            if (boss.x <= 0 || boss.x + boss.width >= canvas.width) {
                boss.dx *= -1;
            }
            bossShootInterval--;
            if (bossShootInterval <= 0) {
                let dir = player.x < boss.x ? -1 : +1;
                bossBullets.push({
                    x: boss.x + boss.width/2,
                    y: boss.y + boss.height,
                    width: 6,
                    height: 3,
                    dx: bossBulletSpeed * dir
                });
                bossShootInterval = bossShootIntervalMax;
            }
            for (let i = bossBullets.length - 1; i >= 0; i--) {
                let b = bossBullets[i];
                b.x += b.dx;
                if (b.x < 0 || b.x > canvas.width) {
                    bossBullets.splice(i, 1);
                    continue;
                }
                if (player.x < b.x + b.width &&
                    player.x + player.width > b.x &&
                    player.y < b.y + b.height &&
                    player.y + player.height > b.y) {
                    gameOver();
                    return;
                }
            }
        }

        function drawBoss() {
            if (!boss) return;
            drawPixel(boss.x, boss.y, boss.width, boss.height, '#800080');
            for (let b of bossBullets) {
                drawPixel(b.x, b.y, b.width, b.height, '#FF00FF');
            }
        }

        function drawGame() {
            drawBackground();

            for (let plat of platforms) {
                drawPixel(plat.x, plat.y, plat.width, plat.height, '#8B4513');
                drawPixel(plat.x, plat.y + plat.height, plat.width, 5, '#654321');
            }

            for (let obs of obstacles) {
                drawPixel(obs.x, obs.y, obs.width, obs.height, '#FF0000');
                drawPixel(obs.x+5, obs.y+5, 10,10, '#8B0000');
            }

            for (let coin of coins) {
                const twinkle = Math.sin(frameCount*0.1) > 0 ? '#FFFF00' : '#FFD700';
                drawPixel(coin.x, coin.y, coin.width, coin.height, twinkle);
                drawPixel(coin.x+2, coin.y+2, 6,6, '#FFFFFF');
            }

            if (door && level < 5) {
                drawPixel(door.x, door.y, door.width, door.height, '#00FF00');
                drawPixel(door.x+5, door.y+5, 10,10, '#FFFFFF');
            }

            drawPlayer();
            drawBoss();

            for (let b of bullets) {
                drawPixel(b.x, b.y, b.width, b.height, '#FFFF00');
            }

            for (let p of particles) {
                drawPixel(p.x, p.y, 2,2, '#D2B48C');
                p.y += p.dy;
                p.life--;
            }
            particles = particles.filter(p => p.life > 0);
        }

        function nextLevel() {
            level++;
            levelElement.textContent = `Level: ${level}`;
            door = null;
            boss = null;
            bullets = [];
            resetGameForLevel();
            if (level >= 5) {
                spawnBoss();
            }
        }

        function resetGameForLevel() {
            player = { x: 50, y: 300, width: 20, height: 20, dx:0, dy:0, onGround:false, canJump:true, frame:0, direction:1 };
            platforms = [{ x:0, y:350, width:800, height:50 }];
            for (let i=0; i<Math.max(1, 4 - level); i++) {
                let x = 200 + i*200;
                let y = 250 - i*50;
                platforms.push({ x: x, y: y, width:100, height:20 });
            }
            obstacles = [];
            for (let i=0; i<level; i++) {
                let x = 200 + i*150;
                let y = 330 - i*50;
                obstacles.push({ x:x, y:y, width:20, height:20, dx:2 + level });
            }
            spawnCoins();
            particles = [];
        }

        function spawnCoins() {
            coins = [];
            for (let i=0; i<3; i++) {
                let plat = platforms[Math.floor(Math.random() * platforms.length)];
                let x = plat.x + Math.random()*(plat.width -20);
                let y = plat.y -30 - Math.random()*50;
                coins.push({ x:x, y:y, width:10, height:10 });
            }
        }

        function gameOver() {
            gameRunning = false;
            gameOverElement.style.display = 'block';
        }

        function resetGame() {
            level = 1;
            levelElement.textContent = `Level: ${level}`;
            door = null;
            boss = null;
            bullets = [];
            resetGameForLevel();
            score = 0;
            energy = 0;
            ultiReady = false;
            scoreElement.textContent = `Skor: ${score}`;
            energyBarFill.style.width = '0%';
            ultiPrompt.style.display = 'none';
            gameOverElement.style.display = 'none';
            gameRunning = true;
        }

        document.addEventListener('keydown', (e) => {
            if (!gameRunning) {
                resetGame();
                return;
            }
            if (e.key === 'ArrowLeft') {
                player.dx = -baseMoveSpeed;
                player.direction = -1;
            }
            if (e.key === 'ArrowRight') {
                player.dx = baseMoveSpeed;
                player.direction = 1;
            }
            if (e.key === 'ArrowUp' && player.canJump) {
                player.dy = jumpStrength;
                player.canJump = false;
                for (let i=0; i<3; i++) {
                    particles.push({ x: player.x + 10, y: player.y + 20, dy: -0.5, life: 15 });
                }
            }
            if (e.key === ' ' && shootCooldown <= 0) {
                bullets.push({
                    x: player.x + player.width/2,
                    y: player.y + player.height/2,
                    width: bulletWidth,
                    height: bulletHeight,
                    dx: bulletSpeed * player.direction
                });
                shootCooldown = shootCooldownMax;
            }
            if (e.key === 'Shift' && ultiReady) {
                useUlti();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                player.dx = 0;
            }
        });

        function useUlti() {
            // Contoh efek ulti: hapus semua rintangan saat ini + bonus skor besar
            obstacles = [];
            score += 500;
            scoreElement.textContent = `Skor: ${score}`;
            energy = 0;
            ultiReady = false;
            energyBarFill.style.width = '0%';
            ultiPrompt.style.display = 'none';
            // Bisa ditambah animasi, suara, efek layarâ€“sesuaikan sendiri
        }

        function gameLoop() {
            updateGame();
            drawGame();
        }

        setInterval(gameLoop, 1000 / 60);
    </script>
</body>
</html>
